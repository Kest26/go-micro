**Подключение Микросервиса Аутентификации к Базе Данных**

---

### **Введение**

В предыдущей лекции мы создали заготовку для микросервиса аутентификации. Теперь нам нужно подключить этот сервис к базе данных, чтобы он мог полноценно функционировать. В этой лекции мы установим необходимые драйверы для работы с базой данных PostgreSQL, реализуем функции для подключения к базе данных и настроим обработку возможных ошибок при подключении.

### **Установка драйверов для PostgreSQL**

Для начала нужно установить драйверы, которые позволят нашему микросервису работать с PostgreSQL. Мы будем использовать пакет `pgx` от разработчика Jack C, который считается одним из лучших на текущий момент.

Перейдите в корневую директорию вашего микросервиса (где находится файл `go.mod`) и выполните следующие команды в терминале:

1. Установите драйвер для PostgreSQL конфигураций:
    ```bash
    go get github.com/jackc/pgconn
    ```
2. Установите основную библиотеку для работы с PostgreSQL:
    ```bash
    go get github.com/jackc/pgx/v4
    ```
    **Важно:** Если уже доступна версия 5 (`v5`), пока оставайтесь на версии 4 (`v4`), чтобы избежать возможных проблем. Позже можно будет обновиться.
3. Установите библиотеку для работы со стандартной библиотекой SQL:
    ```bash
    go get github.com/jackc/pgx/v4/stdlib
    ```

### **Реализация функции для подключения к базе данных**

Подключение к базе данных будет осуществляться с использованием функции `openDB`, которая принимает строку подключения (DSN - Data Source Name) и возвращает указатель на объект `sql.DB`, представляющий соединение с базой данных, а также возможную ошибку.

**Шаги подключения:**

1. Функция `openDB` принимает строку подключения и использует метод `sql.Open` с типом `pgx` для создания соединения.
2. После этого производится проверка соединения с помощью `db.Ping()`.
3. Если все успешно, функция возвращает объект `sql.DB`, иначе — ошибку.

```go
func openDB(dsn string) (*sql.DB, error) {
    db, err := sql.Open("pgx", dsn)
    if err != nil {
        return nil, err
    }

    err = db.Ping()
    if err != nil {
        return nil, err
    }

    return db, err
}
```

### **Обработка ошибок при подключении к базе данных**

Так как микросервис может запуститься раньше, чем будет доступна база данных, мы добавляем функцию `connectToDB`, которая будет повторять попытки подключения к базе данных до тех пор, пока соединение не будет установлено или не будет превышено заданное количество попыток.

**Алгоритм работы функции `connectToDB`:**

1. Функция получает строку подключения из переменной окружения `DSN`.
2. Запускается бесконечный цикл, в котором пытается подключиться к базе данных.
3. Если подключение не удалось, выводится сообщение о том, что база данных еще не готова, и счетчик попыток увеличивается.
4. Если количество попыток превышает заданный лимит (например, 10), процесс подключения прекращается.
5. Между попытками подключения делается пауза в 2 секунды.

```go
func connectToDB() *sql.DB {
    dsn := os.Getenv("DSN")

    for {
        connection, err := openDB(dsn)
        if err != nil {
            log.Println("Postgres not yet ready...")
            counts++
        } else {
            log.Println("Connected to Postgres!")
            return connection
        }

        if counts > 10 {
            log.Println(err)
            return nil
        }

        log.Println("Backing off for two seconds....")
        time.Sleep(2 * time.Second)
        continue
    }
}
```

### **Интеграция с основным приложением**

После того как функции для подключения к базе данных реализованы, их нужно интегрировать в основной файл `main.go` нашего микросервиса.

**Основные шаги:**

1. Подключение к базе данных выполняется при запуске микросервиса.
2. Если соединение установить не удалось, приложение завершает свою работу с ошибкой.
3. После успешного подключения конфигурация приложения обновляется, включая ссылку на базу данных и инициализацию моделей данных.

```go
func main() {
    log.Println("Starting authentication service")

    // Подключение к БД
    conn := connectToDB()
    if conn == nil {
        log.Panic("Can't connect to Postgres!")
    }

    // Настройка конфигурации приложения
    app := Config{
        DB:     conn,
        Models: data.New(conn),
    }

    srv := &http.Server{
        Addr:    fmt.Sprintf(":%s", webPort),
        Handler: app.routes(),
    }

    err := srv.ListenAndServe()
    if err != nil {
        log.Panic(err)
    }
}
```

### **Обновление Импортов**

Не забудьте обновить раздел импортов в файле main.go для включения новых пакетов:

```go
import (
    "authentication/data"
    "database/sql"
    "fmt"
    "log"
    "net/http"
    "os"
    "time"

    _ "github.com/jackc/pgconn"
    _ "github.com/jackc/pgx/v4"
    _ "github.com/jackc/pgx/v4/stdlib"
)

```

_Примечание: Импорты с символом подчеркивания (\_) используются для инициализации пакетов без прямого обращения к ним в коде._

### **Заключение**

Мы успешно реализовали функционал подключения микросервиса аутентификации к базе данных PostgreSQL. В следующей лекции мы добавим Postgres в Docker Compose, создадим пользовательскую таблицу и настроим маршруты для работы с аутентификацией.
