## Добавление MongoDB в наш файл docker-compose.yml

## И проверка интеграции с Go-сервисом

В этой лекции мы добавим MongoDB в конфигурацию Docker Compose, настроим её параметры и проверим подключение к базе данных в нашем Go-приложении. Особое внимание уделим корректному подключению, проверке работы и устранению возможных ошибок.

### 1. Добавление MongoDB в Docker Compose

Начнем с того, что откроем файл `docker-compose.yml` и добавим туда новую секцию для MongoDB. Она должна быть на одном уровне с другими сервисами, такими как Postgres.

Пример настройки:

```yaml
mongo:
    image: "mongo:4.2.16-bionic"
    ports:
        - "27017:27017"
    environment:
        MONGO_INITDB_DATABASE: logs
        MONGO_INITDB_ROOT_USERNAME: admin
        MONGO_INITDB_ROOT_PASSWORD: password
    volumes:
        - ./db-data/mongo/:/data/db
```

Давайте разберем эту конфигурацию:

-   **image**: Указывает на конкретный образ MongoDB версии 4.2.16 на основе Bionic.
-   **ports**: Мы связываем локальный порт `27017` с таким же портом внутри контейнера для доступа к базе данных.
-   **environment**: Устанавливаем начальные переменные среды:
    -   `MONGO_INITDB_DATABASE`: Имя создаваемой базы данных.
    -   `MONGO_INITDB_ROOT_USERNAME` и `MONGO_INITDB_ROOT_PASSWORD`: Задают учетные данные администратора.
-   **volumes**: Настраиваем локальное хранилище данных, чтобы информация сохранялась даже при перезапуске контейнера.

### 2. Запуск контейнеров и проверка MongoDB

После добавления MongoDB в `docker-compose.yml` нам нужно перезапустить все контейнеры:

```sh
make down
make up
```

Эти команды сначала остановят все работающие контейнеры, затем заново их поднимут, загружая нужные образы и применяя конфигурации.

Во время запуска вы можете увидеть, как Docker подтягивает и настраивает MongoDB. Это первый признак того, что все идет по плану.

### 3. Настройка подключения к MongoDB в приложении

Теперь перейдем к коду нашего приложения. Нам нужно обновить URL для подключения к MongoDB в файле `main.go`.

На данном этапе автор лекции временно использует локальный адрес для тестирования:

```go
const mongoURL = "mongodb://localhost:27017"
```

Использование `localhost` вместо `mongo` помогает удостовериться, что конфигурация Docker работает правильно, и MongoDB доступен по указанному адресу.

После успешной проверки подключения, URL будет изменен обратно:

```go
const mongoURL = "mongodb://mongo:27017"
```

Этот адрес (`mongodb://mongo:27017`) является правильным, так как `mongo` — это имя сервиса в Docker Compose, которое автоматически разрешается в сети контейнеров.

В коде также добавляется функция подключения к базе данных `connectToMongo()`, которая настраивает параметры и выполняет подключение к MongoDB. Если подключение успешно, приложение выводит сообщение "Connected to mongo!".

### 4. Запуск и отладка приложения

После того как все настройки внесены, можно запустить приложение:

```sh
go run ./cmd/api
```

На этом этапе могут возникнуть ошибки. Автор лекции проверяет возможные синтаксические ошибки в коде, например, в файле `handlers.go` на 32 строке. Такие ошибки, как отсутствие запятой, легко исправляются:

```go
	srv := &http.Server{
		Addr:    fmt.Sprintf(":%s", webPort),
		Handler: app.routes(), // Добавляем пропущенную запятую
	}
```

После устранения мелких ошибок приложение успешно запускается, но тут возникает другая проблема: приложение сразу же завершается. Это происходит из-за того, что сервер запускается в фоне через горутину:

```go
go app.serve()
```

Сервер запускается асинхронно и основная программа сразу завершается. Исправление заключается в переносе вызова сервера из функции `serve()` в основной поток (функцию `main.go`), чтобы программа продолжала работать.

```go
	srv := &http.Server{
		Addr:    fmt.Sprintf(":%s", webPort),
		Handler: app.routes(),
	}

	err = srv.ListenAndServe()
	if err != nil {
		log.Panic()
	}
```

### 5. Проверка логирования и последующие изменения

После того как ошибки устранены, проверяем вывод лога для диагностики:

```go
log.Println("Starting service on port", webPort)
```

Если сообщение появляется, значит сервер работает корректно.

Теперь можно вернуться к исходной конфигурации с `mongoURL = "mongodb://mongo:27017"` и продолжить интеграцию с другими сервисами, такими как брокер сообщений.

### Заключение

На этом этапе мы успешно настроили **MongoDB** в **Docker Compose**, подключили её к приложению и устранили ряд типичных ошибок, которые могут возникнуть в процессе разработки. Теперь вы готовы расширить конфигурацию, добавив дополнительные сервисы и улучшив взаимодействие между ними.
