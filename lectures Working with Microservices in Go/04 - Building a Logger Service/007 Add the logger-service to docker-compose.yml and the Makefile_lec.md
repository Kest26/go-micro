## Добавление сервиса логирования `logger-service` в Docker Compose и Makefile

В этой лекции мы добавим наш сервис логирования `logger-service` в файл `docker-compose.yml`, а также обновим `Makefile`, чтобы автоматизировать сборку и запуск этого сервиса. Рассмотрим необходимые изменения и шаги для их реализации.

### 1. Добавление сервиса логирования в Docker Compose

Откроем файл `docker-compose.yml`, который находится в корневой папке проекта. Для упрощения задачи мы можем скопировать конфигурацию существующего сервиса (например, `broker-service`) и внести в неё необходимые изменения.

Итак, копируем конфигурацию `broker-service` и вставляем её ниже, затем вносим правки:

```yaml
logger-service:
    build:
        context: ./../logger-service
        dockerfile: ./../logger-service/logger-service.dockerfile
    restart: always
    deploy:
        mode: replicated
        replicas: 1
```

**Что мы изменили:**

-   Назвали новый сервис `logger-service`.
-   Указали путь к папке с исходным кодом сервиса в параметре `context`.
-   Указали путь к Dockerfile для нового сервиса (`dockerfile: ./../logger-service/logger-service.dockerfile`).
-   Убрали секцию `ports`, так как этот сервис не требует внешнего доступа через порты.

Теперь, когда конфигурация сервиса логирования добавлена в Docker Compose, можно переходить к созданию Dockerfile для этого сервиса.

### 2. Создание Dockerfile для сервиса логирования

Для ускорения работы мы можем скопировать уже существующий Dockerfile из `broker-service` и адаптировать его. Перейдём в папку `logger-service` и создадим новый файл `logger-service.dockerfile`, затем вставим следующий код:

```dockerfile
FROM alpine:latest

RUN mkdir /app

COPY loggerServiceApp /app

CMD [ "/app/loggerServiceApp" ]
```

**Основные моменты:**

-   Используем образ на основе Alpine Linux, который лёгкий и минималистичный.
-   Создаём папку `/app` внутри контейнера.
-   Копируем скомпилированный бинарник нашего сервиса (`loggerServiceApp`) в эту папку.
-   Указываем команду, которая будет запускать наш сервис при старте контейнера.

Теперь наш Dockerfile готов, и мы можем переходить к обновлению Makefile, чтобы автоматизировать процесс сборки и запуска.

### 3. Изменение Makefile для поддержки сервиса логирования

Откроем `Makefile` и добавим команды для сборки и запуска сервиса логирования `logger-service`. Сначала скопируем существующую команду сборки, например `build-broker`, и адаптируем её для нашего нового сервиса:

```makefile
## build_logger: builds the logger binary as a linux executable
build_logger:
	@echo "Building logger binary..."
	cd ../logger-service && env GOOS=linux CGO_ENABLED=0 go build -o ${LOGGER_BINARY} ./cmd/api
	@echo "Done!"
```

**Что изменено:**

-   Команду назвали `build_logger`.
-   Указали путь к папке с исходным кодом сервиса логирования.
-   Переменной `LOGGER_BINARY` присвоили значение `loggerServiceApp`.

Теперь добавим эту команду в секцию сборки всех сервисов:

```makefile
up_build: build_broker build_auth build_logger
```

Также необходимо добавить переменную для бинарника в верхней части файла:

```makefile
LOGGER_BINARY=loggerServiceApp
```

После этого не забудем внести аналогичные изменения в Makefile для Windows.

### 4. Проверка работы

Теперь можно протестировать изменения. В терминале перейдите в корневую папку проекта и выполните команду:

```sh
make up_build
```

Если всё настроено правильно, вы увидите, что все сервисы запускаются без ошибок. Это подтверждает корректность конфигурации Docker Compose и Makefile.

## Заключение

В этой лекции мы добавили сервис логирования `logger-service` в Docker Compose, настроили его сборку и автоматический запуск через Makefile. На следующем этапе мы будем вносить изменения в `broker-service`, чтобы он мог принимать запросы на логирование и пересылать их в наш новый сервис.
