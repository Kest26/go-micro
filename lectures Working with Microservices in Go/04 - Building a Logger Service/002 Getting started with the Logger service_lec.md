### Заголовок: Добавление и интеграция сервиса логирования в микросервисную архитектуру

#### Введение в текущую архитектуру микросервисов

На данный момент в нашем проекте реализованы два микросервиса:

1. **Брокер** (broker): это основная и, опционально, единственная точка входа в систему. Он взаимодействует с другими микросервисами и координирует их работу.
   
2. **Сервис аутентификации** (authentication service): этот микросервис отвечает за управление аутентификацией и использует базу данных PostgreSQL для хранения данных о пользователях и других связанных данных.

Эта архитектура уже работает достаточно стабильно, но для улучшения мониторинга и диагностики системы требуется добавить новый компонент — сервис логирования.

#### Добавление сервиса логирования

В этой части курса мы добавим **сервис логирования** (logger service). Он будет принимать логи от других микросервисов и сохранять их в базу данных **MongoDB**. Основными задачами этого сервиса будут сбор, хранение и предоставление логов для дальнейшего анализа.

##### Взаимодействие между сервисами

- **Брокер** будет отправлять логи в этот сервис. Это позволит централизованно отслеживать события, происходящие в системе.
  
- **Сервис аутентификации** также сможет напрямую взаимодействовать с сервисом логирования, отправляя туда свои логи.
  
- Любой другой микросервис, который может быть добавлен в будущем, тоже сможет отправлять логи в этот сервис.

##### Изоляция сервиса логирования

Важно отметить, что сервис логирования будет доступен только внутри кластера микросервисов. Он не будет иметь прямого доступа в Интернет, что повышает безопасность системы. Логирование будет осуществляться внутри:

- **Docker Swarm** (если используется кластеризация),
- **Docker** (если система развернута как отдельные контейнеры, как на текущем этапе),
- **Kubernetes** (в будущем для более сложных развертываний).

#### Подготовка к реализации: Загрузка необходимых зависимостей

Перед тем как приступить к реализации, нужно убедиться, что у нас есть все необходимые зависимости для работы с MongoDB в Go.

##### Установка MongoDB драйвера

Первым шагом является установка драйвера MongoDB для Go. Для этого в проекте необходимо выполнить команду:

```bash
go get go.mongodb.org/mongo-driver/mongo
```

Этот пакет предоставляет все необходимые инструменты для работы с MongoDB, включая подключение, выполнение запросов и управление данными.

##### Загрузка опций для MongoDB

Для управления настройками подключения и аутентификации, нам также понадобится пакет опций:

```bash
go get go.mongodb.org/mongo-driver/mongo/options
```

Этот пакет позволяет конфигурировать соединение с MongoDB, включая установку URI, аутентификацию и другие параметры.

#### Реализация подключения к MongoDB

После установки всех необходимых зависимостей, мы можем приступить к написанию кода для подключения сервиса логирования к базе данных MongoDB.

##### Определение констант и глобальных переменных

Начнем с определения констант, которые будут использоваться для конфигурации сервиса логирования:

```go
const (
	webPort  = "80"                        // Порт для веб-сервера
	rpcPort  = "5001"                      // Порт для RPC-сервера
	mongoURL = "mongodb://mongo:27017"     // URL для подключения к MongoDB
	gRpcPort = "50001"                     // Порт для gRPC-сервера
)

var client *mongo.Client  // Глобальная переменная для хранения клиента MongoDB
```

Здесь мы определили порты для различных типов связи и указали URL для подключения к MongoDB. Глобальная переменная `client` будет хранить подключение к MongoDB, чтобы его можно было использовать в других частях программы.

##### Основная функция `main()`

Функция `main()` будет отвечать за начальную настройку и подключение к базе данных MongoDB:

```go
func main() {
	// Подключение к MongoDB
	mongoClient, err := connectToMongo()
	if err != nil {
		log.Panic(err)
	}

	client = mongoClient  // Сохранение клиента MongoDB в глобальной переменной
}
```

В этой функции мы вызываем `connectToMongo()` для установления соединения с MongoDB. Если подключение не удалось, программа завершает работу с выводом сообщения об ошибке.

##### Функция `connectToMongo()`

Функция `connectToMongo()` реализует логику подключения к MongoDB:

```go
func connectToMongo() (*mongo.Client, error) {
	// Создание опций подключения
	clientOptions := options.Client().ApplyURI(mongoURL)
	clientOptions.SetAuth(options.Credential{
		Username: "admin",       // Имя пользователя MongoDB
		Password: "password",    // Пароль для доступа к MongoDB
	})

	// Установление подключения
	c, err := mongo.Connect(context.TODO(), clientOptions)
	if err != nil {
		log.Println("Ошибка подключения:", err)
		return nil, err
	}

	return c, nil
}
```

Эта функция выполняет несколько ключевых задач:

1. **Создание опций подключения**: Мы используем `options.Client().ApplyURI(mongoURL)` для указания URL базы данных MongoDB. Также задаются параметры аутентификации (имя пользователя и пароль) через метод `SetAuth()`.

2. **Установление подключения**: Метод `mongo.Connect()` выполняет соединение с базой данных, используя заданные параметры. Если подключение успешно, возвращается объект клиента MongoDB, в противном случае выводится сообщение об ошибке, и функция возвращает `nil`.

#### Заключение

Добавление сервиса логирования в микросервисную архитектуру значительно повысит возможности мониторинга и диагностики системы. Этот сервис будет собирать логи от всех микросервисов и сохранять их в базе данных MongoDB, обеспечивая тем самым централизованное управление логами.

В следующей части курса мы будем развивать этот сервис, добавляя возможность обработки логов и интеграцию с другими частями системы, а также рассмотрим вопросы безопасности и масштабирования логирования в микросервисной архитектуре.
